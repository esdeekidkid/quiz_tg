    <script>
        let lectureText = null; // Хранит текст лекции после загрузки PDF
        let parsedQuestions = null; // Хранит вопросы после парсинга

        document.getElementById('upload-pdf-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusDiv = document.getElementById('status-pdf');
            statusDiv.className = '';
            statusDiv.textContent = 'Загрузка...';

            const formData = new FormData();
            const fileInput = document.getElementById('pdf-file');
            if (!fileInput.files[0]) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: файл не выбран.';
                return;
            }
            formData.append('file', fileInput.files[0]);

            try {
                const response = await fetch('/api/extract-text-from-pdf/', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                if (!response.ok) {
                    // --- Обновлено ---
                    let errorMsg = 'Неизвестная ошибка сервера при загрузке PDF';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                lectureText = data.text;
                statusDiv.className = 'success';
                statusDiv.textContent = `PDF загружен. Длина: ${data.length} символов. Сниппет: "${data.snippet.substring(0, 100)}${data.snippet.length > 100 ? '...' : ''}"`;

            } catch (error) {
                // --- Обновлено ---
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка загрузки: ${errorMessage}`;
            }
        });

        async function parseQuiz() {
            const statusDiv = document.getElementById('status-quiz-parse');
            statusDiv.className = '';
            statusDiv.textContent = 'Разбор...';
            const parsedQuestionsDiv = document.getElementById('parsed-questions');
            const processParsedBtn = document.getElementById('process-parsed-btn');

            const html = document.getElementById('quiz-html').value.trim();
            if (!html) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: введите HTML теста.';
                return;
            }

            try {
                const response = await fetch('/api/parse-quiz-html/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ html: html })
                });

                const data = await response.json();
                if (!response.ok) {
                    // --- Обновлено ---
                    let errorMsg = 'Неизвестная ошибка сервера при разборе HTML';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                parsedQuestions = data.questions;
                statusDiv.className = 'success';
                statusDiv.textContent = `Найдено ${parsedQuestions.length} вопросов.`;

                // Отобразить вопросы
                parsedQuestionsDiv.innerHTML = '';
                parsedQuestions.forEach((q, index) => {
                    const qDiv = document.createElement('div');
                    qDiv.className = 'parsed-question';
                    qDiv.innerHTML = `
                        <h4>Вопрос ${index + 1}:</h4>
                        <p><strong>Текст:</strong> ${q.question}</p>
                        <p><strong>Тип:</strong> ${q.is_short ? 'Короткий ответ' : 'Множественный выбор'}</p>
                        <p><strong>Опции:</strong> ${q.options.join(', ')}</p>
                        <hr>
                    `;
                    parsedQuestionsDiv.appendChild(qDiv);
                });
                parsedQuestionsDiv.style.display = 'block';
                processParsedBtn.style.display = 'inline-block';

            } catch (error) {
                // --- Обновлено ---
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка разбора: ${errorMessage}`;
                parsedQuestionsDiv.style.display = 'none';
                processParsedBtn.style.display = 'none';
            }
        }

        async function processParsedQuiz() {
            const statusDiv = document.getElementById('status-quiz-parse');
            statusDiv.className = '';
            statusDiv.textContent = 'Сопоставление...';
            const resultsDiv = document.getElementById('results');

            // --- Проверки ---
            if (!lectureText) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: сначала загрузите PDF.';
                resultsDiv.textContent = 'Сначала загрузите PDF.';
                console.error("processParsedQuiz: lectureText is null or undefined");
                return;
            }

            if (!parsedQuestions || parsedQuestions.length === 0) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: сначала разберите HTML.';
                resultsDiv.textContent = 'Сначала разберите HTML.';
                console.error("processParsedQuiz: parsedQuestions is null, undefined, or empty");
                return;
            }

            // --- Проверим типы данных ---
            if (typeof lectureText !== 'string') {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: текст лекции имеет неверный тип.';
                console.error("processParsedQuiz: lectureText is not a string:", typeof lectureText);
                return;
            }

            if (!Array.isArray(parsedQuestions)) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: вопросы имеют неверный тип.';
                console.error("processParsedQuiz: parsedQuestions is not an array:", typeof parsedQuestions);
                return;
            }

            // --- Подготовим объект для отправки ---
            const payload = {
                questions: parsedQuestions,
                lecture_text: lectureText
            };

            // --- Логируем, что собираемся отправить ---
            console.log("processParsedQuiz: Sending payload to API:", payload);

            // --- Проверим, что в payload есть нужные поля ---
            if (!payload.questions || !payload.lecture_text) {
                statusDiv.className = 'error';
                statusDiv.textContent = 'Ошибка: подготовленный объект для отправки некорректен.';
                console.error("processParsedQuiz: payload is missing questions or lecture_text", payload);
                return;
            }

            try {
                const response = await fetch('/api/process-quiz/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload) // <-- Отправляем подготовленный объект
                });

                // --- Логируем статус ответа ---
                console.log("processParsedQuiz: Response status:", response.status);

                const data = await response.json();
                if (!response.ok) {
                    // --- Обновлено ---
                    let errorMsg = 'Неизвестная ошибка сервера при обработке вопросов';
                    if (data && typeof data === 'object' && data.detail) {
                        if (typeof data.detail === 'string') {
                            errorMsg = data.detail;
                        } else {
                            try {
                                errorMsg = JSON.stringify(data.detail);
                            } catch (e) {
                                errorMsg = String(data.detail);
                            }
                        }
                    } else if (response.statusText) {
                        errorMsg = response.statusText;
                    }
                    throw new Error(errorMsg);
                }

                statusDiv.className = 'success';
                statusDiv.textContent = 'Вопросы сопоставлены успешно!';
                resultsDiv.textContent = JSON.stringify(data.results, null, 2); // Форматированный JSON

            } catch (error) {
                // --- Обновлено ---
                statusDiv.className = 'error';
                let errorMessage = error.message;
                if (typeof error.message === 'object') {
                    try {
                        errorMessage = JSON.stringify(error.message);
                    } catch (e) {
                        errorMessage = String(error.message);
                    }
                }
                statusDiv.textContent = `Ошибка сопоставления: ${errorMessage}`;
                resultsDiv.textContent = `Ошибка: ${errorMessage}`;
                console.error("processParsedQuiz: Fetch error:", error); // Логируем ошибку fetch
            }
        }
    </script>
